<!DOCTYPE html><html lang="id"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rekap Periode — Total Bayar Per Periode</title>
<link rel="stylesheet" href="styles/system.css"/>
<link rel="stylesheet" href="styles/pages.css"/></head><body>
<div class="page-shell container">
<header class="section-header"><h1>Rekap Periode</h1><div class="section-subtitle">Periode & Total Bayar Periode (tersimpan otomatis & saat klik <em>Simpan</em> di form).</div></header>
<main class="page-content">
  <section class="card">
    <div class="action-bar">
      <button id="btnOpenForm" class="btn btn-primary" type="button" title="Buka form baru di tab baru (auto-close)" aria-label="Buka form baru di tab baru (auto-close)">
        <span class="btn__icon" aria-hidden="true">
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 10h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 4v12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span class="btn__label">Form Baru</span>
      </button>
      <span id="seqBadge" class="badge">Next: ?new=1</span>
      <button id="btnResetSeq" class="btn btn-secondary">Reset Nomor (?new=1)</button>
      <button id="btnReload" class="btn btn-secondary">Muat Ulang</button>
      <select id="order" class="input-select"><option value="desc" selected>Urut Terbaru → Lama</option><option value="asc">Urut Lama → Terbaru</option></select>
      <button id="btnExport" class="btn btn-secondary">Ekspor CSV</button><input id="imp" type="file" accept=".csv,text/csv" style="display:none"/><button id="btnImport" class="btn btn-secondary">Impor CSV</button>
      <span class="badge" id="counter">0 periode</span>
    </div>
  </section>
  <section class="card table-card"><div class="table-card__scroller">
    <table class="table"><thead><tr>
  <th>Periode Mulai</th>
  <th>Periode Selesai</th>
  <th class="right">Total Bayar Periode</th>
  <th>Sumber</th>
  <th>Aksi</th>
</tr></thead>
      <tbody id="tbody"><tr class="empty-state"><td colspan="5">Belum ada data. Buka form, isi & tekan <b>Simpan</b>.</td></tr></tbody>
      <tfoot><tr><td colspan="2" class="right sum">GRAND TOTAL</td><td id="grand" class="right sum">Rp 0</td></tr></tfoot>
    </table></div>
  </section>
</main>
</div>
<script src="assets/js/export-utils.js"></script>
<script>
  const KEY_HISTORY='upah20_period_history_v2', KEY_SEQ='upah20_new_sequence_counter';
  function load(){ try{return JSON.parse(localStorage.getItem(KEY_HISTORY))||[];}catch(_){return [];} }
  function rp(n){ n=Number(n||0); return 'Rp ' + n.toLocaleString('id-ID'); }
  function getSeq(){ const v=parseInt(localStorage.getItem(KEY_SEQ)||'1',10); return isNaN(v)||v<1?1:v; }
  function setSeq(n){ localStorage.setItem(KEY_SEQ,String(n)); }
  function refreshBadge(){ document.getElementById('seqBadge').textContent='Next: ?new='+getSeq(); }
  function downloadFile(content, mime, filename){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }
  function exportFormDataAs(format){
    if (!window.UpahExport){
      alert('Fitur ekspor belum tersedia.');
      return;
    }
    const dataset = (typeof window.UpahExport.loadActiveDataset === 'function')
      ? window.UpahExport.loadActiveDataset()
      : null;
    if (!dataset){
      alert('Data form tidak ditemukan. Buka form dan simpan terlebih dahulu.');
      return;
    }
    const exportData = window.UpahExport.buildSections(dataset);
    const nameFn = (typeof window.UpahExport.timestampName === 'function')
      ? window.UpahExport.timestampName
      : ((prefix, ext)=> `${prefix}.${ext}`);
    if (format === 'xlsx'){
      if (typeof window.UpahExport.sectionsToXLSX !== 'function'){
        alert('Ekspor XLSX tidak tersedia.');
        return;
      }
      const workbook = window.UpahExport.sectionsToXLSX(exportData.sections);
      downloadFile(workbook, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', nameFn('upah7hari', 'xlsx'));
      return;
    }
    const csv = window.UpahExport.sectionsToCSV(exportData.sections);
    downloadFile(csv, 'text/csv;charset=utf-8', nameFn('upah7hari', 'csv'));
  }
  function render(){
    let arr=load(); const order=document.getElementById('order').value||'desc'; const tbody=document.getElementById('tbody'); tbody.innerHTML='';
    if(!arr.length){ tbody.innerHTML='<tr class="empty-state"><td colspan="5">Belum ada data. Buka form, isi & tekan <b>Simpan</b>.</td></tr>'; document.getElementById('counter').textContent='0 periode'; document.getElementById('grand').textContent='Rp 0'; return; }
    arr.sort((a,b)=> order==='desc'? b.periodeMulai.localeCompare(a.periodeMulai) : a.periodeMulai.localeCompare(b.periodeMulai));
    let grand=0; for(const r of arr){
      grand+=Number(r.sumTotal||0);
      const tr=document.createElement('tr');
      const key = `${r.periodeMulai||''}__${r.periodeSelesai||''}`;
      const rawSnapshotKey = typeof r.snapshotKey === 'string' ? r.snapshotKey.trim() : '';
      const snapshotKey = rawSnapshotKey ? rawSnapshotKey : null;
      const hasServerSnapshot = !!snapshotKey;
      const histToken = (typeof r.hist === 'string' && r.hist) ? r.hist : (r.periodeMulai || '');
      const fallbackLink = `form.html?hist=${encodeURIComponent(histToken)}`;
      let linkHref = fallbackLink;
      if (hasServerSnapshot) {
        const params = new URLSearchParams();
        params.set('snapshot', snapshotKey);
        if (histToken) params.set('hist', histToken);
        linkHref = `form.html?${params.toString()}`;
      }
      const sourceAttr = hasServerSnapshot ? 'server-form' : 'form';
      const sourceTitle = hasServerSnapshot ? 'Muat form dari snapshot server' : 'Data lokal (form)';
      tr.innerHTML = `
  <td>${r.periodeMulai||''}</td>
  <td>${r.periodeSelesai||''}</td>
  <td class="right">${rp(r.sumTotal||0)}</td>
      <td><a href='${linkHref}' target='_blank' rel='noopener' data-source='${sourceAttr}' title='${sourceTitle}'>Buka Data</a></td>
  <td><button class="btn btn-secondary btnDel" data-k="${key}" title="Hapus baris ini">Hapus</button></td>
`; tbody.appendChild(tr); }
    document.getElementById('counter').textContent=arr.length+' periode'; document.getElementById('grand').textContent=rp(grand);
  }
  document.getElementById('btnOpenForm').addEventListener('click', ()=>{ const n=getSeq(); window.open('UPAH_TUKANG_7_HARI_period_calendar- Master_autosave_patched.html?new='+n,'_blank'); setTimeout(()=>{ setSeq(getSeq()+1); refreshBadge(); },200); });
  document.getElementById('btnResetSeq').addEventListener('click', ()=>{ if(confirm('Reset urutan ke ?new=1?')){ setSeq(1); refreshBadge(); } });
  document.getElementById('btnReload').addEventListener('click', render);
  document.getElementById('order').addEventListener('change', render);
  document.getElementById('btnExport').addEventListener('click', ()=>{
    try {
      exportFormDataAs('csv');
    } catch(err){
      console.error(err);
      alert('Gagal mengekspor data.');
    }
  });

// === Import CSV (merge to history) ===
document.getElementById('btnImport').addEventListener('click', ()=>{
  document.getElementById('imp').click();
});
document.getElementById('imp').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try {
    const text = await f.text();
    // very simple CSV parse (handles quotes)
    const rows = text.replace(/\r/g,'').split('\n').filter(Boolean).map(line=>{
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){
          if(q && line[i+1] === '"'){ cur += '"'; i++; } else { q=!q; }
        }else if(ch === ',' && !q){ out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out.map(s=>s.trim());
    });
    if(!rows.length) return alert('File kosong');
    const header = rows[0].map(h=>h.toLowerCase());
    const idxMulai = header.indexOf('periode mulai');
    const idxSelesai = header.indexOf('periode selesai');
    const idxTotal = header.indexOf('total bayar periode');
    if(idxMulai<0 || idxSelesai<0 || idxTotal<0){
      return alert('Header tidak cocok. Butuh kolom: Periode Mulai, Periode Selesai, Total Bayar Periode');
    }
    const incoming = rows.slice(1).map(r=> ({
      periodeMulai: r[idxMulai]||'',
      periodeSelesai: r[idxSelesai]||'',
      sumTotal: Number((r[idxTotal]||'0').toString().replace(/[^\d.-]/g,'')) || 0
    })).filter(x=>x.periodeMulai);

    const KEY_HISTORY='upah20_period_history_v2';
    const current = (function(){ try{return JSON.parse(localStorage.getItem(KEY_HISTORY))||[];}catch(_){return [];} })();
    const keyOf = (o)=> `${o.periodeMulai}__${o.periodeSelesai}`;
    const map = new Map(current.map(o=>[keyOf(o), o]));
    let added=0, updated=0;
    for(const it of incoming){
      const k=keyOf(it);
      if(map.has(k)){
        const prev = map.get(k);
        if(Number(prev.sumTotal||0) !== Number(it.sumTotal||0)){
          map.set(k, {...prev, sumTotal: it.sumTotal}); updated++;
        }
      } else {
        map.set(k, it); added++;
      }
    }
    const merged = Array.from(map.values());
    localStorage.setItem(KEY_HISTORY, JSON.stringify(merged));
    alert(`Import selesai. Ditambahkan: ${added}, Diupdate: ${updated}.`);
    render();
  } catch(err){
    console.error(err);
    alert('Gagal mengimpor CSV.');
  } finally {
    e.target.value='';
  }
});

// Auto-refresh when page gains focus, becomes visible, restored from BFCache, or storage changes in another tab
window.addEventListener('focus', render);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) render(); });
window.addEventListener('pageshow', (e)=>{ if(e.persisted) render(); });
window.addEventListener('storage', (e)=>{ if(e.key === KEY_HISTORY) render(); });

refreshBadge();
render();
function removeByKey(k){
  const arr = load().filter(o => `${o.periodeMulai}__${o.periodeSelesai}` !== k);
  localStorage.setItem(KEY_HISTORY, JSON.stringify(arr));
  render();
}

document.getElementById('tbody').addEventListener('click', (e)=>{
  const btn = e.target.closest('.btnDel');
  if(!btn) return;
  const k = btn.getAttribute('data-k');
  if(!k) return;
  if(confirm('Hapus entri periode ini?')){
    removeByKey(k);
  }
});

</script>

<script>
const __API_BASE__='/.netlify/functions/state';
async function serverGetRaw(key){
  try{
    const r = await fetch(__API_BASE__+'?key='+encodeURIComponent(key), { credentials:'same-origin' });
    if(!r.ok) return null;
    return await r.json();
  }catch(_){ return null; }
}
async function serverSetRaw(key, data){
  try{
    await fetch(__API_BASE__, {
      method:'POST',
      headers:{'content-type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify({ key, data })
    });
  }catch(_){}
}
async function syncFromServer(keys){
  for(const k of keys){
    const v = await serverGetRaw(k);
    if(v!==null){
      try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){}
    }
  }
}
async function syncToServer(keys){
  for(const k of keys){
    let v=null;
    try{ v = localStorage.getItem(k); }catch(_){}
    try{ await serverSetRaw(k, v ? JSON.parse(v) : null); }catch(_){}
  }
}
</script>

<script>
(function(){
  const KEY_HISTORY='upah20_period_history_v2';
  const KEY_SEQ='upah20_new_sequence_counter';
  async function initialSync(){
    await syncFromServer([KEY_HISTORY, KEY_SEQ]);
    try{
      if (typeof render === 'function') render();
      if (typeof refreshBadge === 'function') refreshBadge();
    }catch(_){}
  }

  function hookButtons(){
    try{
      const ids=['btnImport','btnExport','btnReload','btnResetSeq'];
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('click', ()=>{
          setTimeout(()=>{ syncToServer([KEY_HISTORY, KEY_SEQ]); }, 300);
        });
      });
      const tb=document.getElementById('tbody');
      if(tb){
        tb.addEventListener('click', (e)=>{
          if(e.target && e.target.closest('.btnDel')){
            setTimeout(()=>{ syncToServer([KEY_HISTORY]); }, 300);
          }
        });
      }
      window.addEventListener('storage', (e)=>{
        if(e.key===KEY_HISTORY || e.key===KEY_SEQ){
          setTimeout(()=>{ syncToServer([KEY_HISTORY, KEY_SEQ]); }, 200);
        }
      });
    }catch(_){}
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(()=>{ initialSync(); hookButtons(); }, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){
      initialSync(); hookButtons();
    }, {once:true});
  }
})();
</script>


<!-- Fix: robust opener and link normalization -->
<script>
(function(){
  function normalizeLinks(){
    try{
      var tbody = document.getElementById('tbody');
      if(!tbody) return;
      tbody.querySelectorAll('a').forEach(function(a){
        try{
          var u = new URL(a.href, location.href);
          if (a.dataset && a.dataset.source === 'server') return;
          if(/\/\.netlify\/functions\/snapshot/i.test(u.pathname)) return;
          if(!/form\.html$/i.test(u.pathname)){
            // assume it was the old long name; switch to form.html while preserving query (?hist=...)
            var hist = u.searchParams.get('hist');
            var nu = new URL('form.html', location.href);
            if(hist) nu.searchParams.set('hist', hist);
            a.href = nu.toString();
          }
        }catch(_){}
      });
    }catch(_){}
  }

  function installBtnFix(){
    var btn = document.getElementById('btnOpenForm');
    if(!btn) return;
    // Remove previous listeners by node replacement
    var clone = btn.cloneNode(true);
    btn.replaceWith(clone);
    btn = clone;
    btn.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopImmediatePropagation();
      var n = (typeof getSeq==='function' ? getSeq() : 1);
      var url = new URL('form.html', location.href);
      url.searchParams.set('new', n);
      try{
        var r = await fetch(url.toString(), { method:'HEAD' });
        if(!r.ok) throw 0;
        window.open(url.toString(), '_blank');
        if (typeof setSeq==='function' && typeof refreshBadge==='function'){
          setTimeout(function(){ setSeq(n+1); refreshBadge(); }, 200);
        }
      }catch(_){
        alert('Halaman form tidak ditemukan di: ' + url.pathname + '\nPastikan "form.html" ada di folder yang sama.');
      }
    });
  }

  function wrapRender(){
    try{
      var orig = window.render;
      if(typeof orig !== 'function') return;
      window.render = function(){
        var res = orig.apply(this, arguments);
        try{ normalizeLinks(); }catch(_){}
        return res;
      };
    }catch(_){}
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(function(){ installBtnFix(); wrapRender(); normalizeLinks(); }, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){
      installBtnFix(); wrapRender(); normalizeLinks();
    }, {once:true});
  }
})();
</script>

</body></html>